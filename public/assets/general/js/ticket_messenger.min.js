class TicketMessenger{constructor(e,s,t,a){this.apiBaseUrl=e,this.payload=s,this.classHandlerVar=a,this.profiles={},this.debugMode=!1,this.lastMessageSenderId=-1,this.lastMessageId=null,this.fetchMessageDelay=5e3,this.modalZoomImage=new ModalZoomImage,this.displayView("site_footer",!1),this.MESSAGE_TYPE_TEXT="Text",this.MESSAGE_TYPE_IMAGE="Image",this.MESSAGE_TYPE_TICKET_IMAGE="TicketImage",this.MESSAGE_TYPE_CHATBOT_IMAGE="ChatbotImage",this.mainCanvas=this.getView(t),this.loadingTemplate=this.getView("LoadingTemplate"),this.messageTemplate=this.getView("MessageTemplate"),this.userProfileTemplate=this.getView("UserProfileTemplate"),this.replierProfileTemplate=this.getView("ReplierProfileTemplate"),this.clearCanvas(this.mainCanvas),this.getInitialData()}log(e,s=!1,t="info"){if(!this.isEmpty(e)){if(s)try{var a="";a="string"==typeof e||e instanceof String?e:JSON.stringify(e);var i=this.getServerConnection("log");i.appendData("type",t),i.appendData("message",a),i.connect()}catch(e){}if(this.debugMode)switch(t){case"info":case"notice":default:console.log(e);break;case"emergency":case"critical":case"error":case"debug":console.error(e);break;case"alert":case"warning":console.warn(e)}}}getView(e,s=!1){try{var t=document.getElementById(e);return is_ElementExist(t)?t:null}catch(t){s&&(alert("No view found with this ID: "+e),this.log(t))}return null}clearCanvas(e){e.innerHTML=""}isEmpty(e){return void 0===e||(null===e||""===e)}scrolldown(){var e=this.mainCanvas;setTimeout((()=>{e.scrollTo(0,e.scrollHeight)}),200)}displayView(e,s=!0){var t=this.getView(e);if(is_ElementExist(t)){var a="d-none",i=func_hasClass(t,a);s&&i?toggleElementClass(e,a):s||i||toggleElementClass(e,a)}}replaceNull(e){return null==e?"":e}booleanValue(e){return"true"==(e=String(e).toLowerCase())||"1"==e}displayWaiting(e=!0){var s="WaitingView";this.removeView(s),e&&this.addTemplateToView(this.mainCanvas,this.loadingTemplate,s)}removeView(e){for(var s=document.getElementById(e);null!=s;)s.parentNode.removeChild(s),s=document.getElementById(e)}getTemporaryID(e=null){var s=Math.floor(100*Math.random())+1,t=Date.now()+""+s;return null!=e&&(t=(e=e.trim())+t),is_ElementExist(this.getView(t))?this.getTemporaryID(e):t}addLocalMessageView(e){var s={id:this.getTemporaryID("text_msg_"),userId:null,type:this.MESSAGE_TYPE_TEXT,content:'<i class="fa fa-message-bot" ></i><br>'+e,updated_at:""};this.addMessageView(s)}addMessageView(e){if(null!=e){var s,t,a,i,l,r,n=null;try{switch(s=e.id,t=e.user_id,a=e.type,i=e.content,l=e.updated_at,r=a,this.isEmpty(t)||this.addProfileView(t),a){case this.MESSAGE_TYPE_TEXT:n=this.getMsgTextView(i),r=a;break;case this.MESSAGE_TYPE_TICKET_IMAGE:n=this.getMsgImageView(this.ticketImagePath+i),r=this.MESSAGE_TYPE_IMAGE;break;case this.MESSAGE_TYPE_CHATBOT_IMAGE:n=this.getMsgImageView(this.chatbotUserInputImagePath+i),r=this.MESSAGE_TYPE_IMAGE}}catch(e){n=null,this.log(e,!1,"error")}if(null!=n){var o={userId:t,messageType:r,messageView:n,messageTime:l};this.addTemplateToView(this.mainCanvas,this.messageTemplate,s,o)}}}addProfileView(e){var s="",t=this.getTemporaryID("profileView_"),a={userId:e,viewId:t},i=!1;(this.lastMessageSenderId!=e&&(i=!0,this.lastMessageSenderId=e),i)&&(s=this.userId==e?this.userProfileTemplate:this.replierProfileTemplate,this.addTemplateToView(this.mainCanvas,s,t,a))}convertLinkToClickable(e){if(!this.isEmpty(e)){return e.replace(/(https?:\/\/[^\s]+)/g,(function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"}))}return e}getMsgTextView(e){var s=null,t=e.replaceAll("\n","<br>");return null!=t&&""!=t&&(s='<small class="text-muted">'+this.convertLinkToClickable(t)+"</small>"),s}getMsgImageView(e){var s=null;return null!=e&&""!=e&&(s='<img class="chat-image" ',s+=' src="'+e+'"',s+=' onclick="'+this.classHandlerVar+'.zoomImage(this);" ',s+=" >"),s}zoomImage(e){this.modalZoomImage.setImage(e.src),this.modalZoomImage.show()}addTemplateToView(e,s,t,a){var i=this.modifyTempalte(s,t,a);if(null==t)e.innerHTML+=i;else{var l="<div id='"+t+"'>";l+=i,l+="</div>",e.innerHTML+=l}this.scrolldown()}modifyTempalte(e,s,t){null==s&&(s=this.getTemporaryID());var a=e.innerHTML;if("MessageTemplate"==e.id){var i=t.userId==this.userId,l=t.messageType,r=t.messageView,n=t.messageTime;a=(a=(a=(a=(a=a.replaceAll("MessageTemplate_isUserMessage",i)).replaceAll("MessageTemplate_MessageType",l)).replaceAll("MessageTemplate_Style1",i?"ms-5":"me-5 flex-row-reverse")).replaceAll("MessageTemplate_MessageView",r)).replaceAll("MessageTemplate_MessageTime",n)}else if("ReplierProfileTemplate"==e.id||"UserProfileTemplate"==e.id){var o=t.viewId,h=o+"_section",g=o+"_image",d=o+"_name";this.getProfileData(t.userId).then((e=>{this.displayView(h,!0);var s=this.getView(g),t=this.getView(d);s.src=e.profileImage,t.innerHTML=e.dispalyName,this.displayView(h,!0)}),(()=>{}));a=(a=(a=a.replaceAll("ProfileTemplate_SectionId",h)).replaceAll("ProfileTemplate_ImageId",g)).replaceAll("ProfileTemplate_NameId",d)}return a}getServerConnection(e,s=null,t=!0){t&&this.displayWaiting(!0);var a=new ServerConnection(this.apiBaseUrl);return a.setSubUrl("tickets/messenger/"+e),a.setMethod("POST"),a.appendHeader("locale",locale),a.appendData("payload",this.payload),a.setOnFailed(function(e,t,a){var i=JSON.parse(e.responseText),l=i.data,r="";if("string"==typeof i.message)r=i.message;else try{i.message.forEach((e=>{r+="* "+e+"\n"}))}catch(e){r=JSON.stringify(i.message,null,2)}"exception.CSRF token mismatch."==r&&window.location.reload(),this.isEmpty(l)||(!0===l.refreshPage&&window.location.reload(),this.applyDefaultData(l)),this.log(r,!1,"warning"),this.displayWaiting(!1),r.includes("exception")||this.addLocalMessageView(r),null!=s&&s(i)}.bind(this)),a}addReceivedMessages(e){this.isEmpty(e)||e.forEach((e=>{var s=this.getView(e.id);this.isEmpty(s)&&this.addMessageView(e)}))}applyDefaultData(e){if(null!=e){var s=e.csrfToken;if(!this.isEmpty(s)){var t=document.getElementsByName("csrf-token");t.length>0&&((t=t[0]).content=s)}this.isEmpty(e.debugMode)||(this.debugMode=this.booleanValue(e.debugMode)),this.isEmpty(e.canSendMessage)||this.displayView("new_message_section",this.booleanValue(e.canSendMessage)),this.isEmpty(e.lastMessageId)||(this.lastMessageId=e.lastMessageId),this.isEmpty(e.synchronize)||(this.synchronize=this.booleanValue(e.synchronize))}}getInitialData(){var e=this.getServerConnection("get_initial_data");e.setOnSuccess(function(e){var s=JSON.parse(e);this.log("getInitialData:\n"+e);var t=s.data;this.displayWaiting(!1),this.userId=t.userId,this.debugMode=this.booleanValue(t.debugMode),this.profiles=t.usersProfiles,this.ticketImagePath=t.imagesBasePath.ticketImage,this.chatbotUserInputImagePath=t.imagesBasePath.chatbotUserInputImage,this.applyDefaultData(t),this.getPreviousMessages(!0);var a=setInterval((()=>{this.synchronize?this.getPreviousMessages():clearInterval(a)}),this.fetchMessageDelay)}.bind(this)),e.connect()}getProfileData(e){return new Promise(((s,t)=>{try{if(null!=this.profiles){var a=this.profiles;if(!this.isEmpty(a[e])){var i=a[e];if(!this.isEmpty(i.dispalyName)&&!this.isEmpty(i.profileImage))return void s(i)}}}catch(e){this.log("Profile data fetch error. \n Exception: "+e,!0,"error")}var l=this.getServerConnection("get_profile_data",(e=>{t(e)}));l.appendData("userId",e),l.setOnSuccess(function(t){var a=JSON.parse(t);this.log("getProfileData:\n"+t);var i=a.data;this.displayWaiting(!1),this.profiles[e]={dispalyName:i.dispalyName,profileImage:i.profileImage},this.applyDefaultData(i),this.scrolldown(),s(this.profiles[e])}.bind(this)),l.connect()}))}getPreviousMessages(e=!1){var s=this.getServerConnection("get_previous_messages",null,e);s.appendData("lastMessageId",e?null:this.lastMessageId),s.setOnSuccess(function(e){var s=JSON.parse(e);this.log("getPreviousMessages:\n"+e);var t=s.data;this.displayWaiting(!1),this.addReceivedMessages(t.messages),this.applyDefaultData(t)}.bind(this)),s.connect()}sendMessage(e){var s=e.tagName.toLowerCase(),t=this.getServerConnection("new_message");if(t.appendData("lastMessageId",this.lastMessageId),"input"==s&&"file"==e.type){var a=e.files[0];t.appendData("attachedFile",a)}else t.appendData("message",e.value);t.setOnSuccess(function(s){var t=JSON.parse(s);this.log("sendMessage:\n"+s),e.value="";var a=t.data;this.displayWaiting(!1),this.addReceivedMessages(a.messages),this.applyDefaultData(a)}.bind(this)),t.connect()}changeTicketStatus(e){var s=this.getServerConnection("change_ticket_status",null,!1);s.appendData("status",e.value),s.setOnSuccess(function(e){var s=JSON.parse(e);this.addLocalMessageView(s.message);var t=s.data;t.refreshPage&&window.location.reload(),this.applyDefaultData(t)}.bind(this)),s.connect()}submitForm(){var e=this.getServerConnection("submit_form",null,!1);e.appendData("privateNote",func_getView("private_note").value),e.setOnSuccess(function(e){var s=JSON.parse(e);this.addLocalMessageView(s.message);var t=s.data;t.refreshPage&&window.location.reload(),this.applyDefaultData(t)}.bind(this)),e.connect()}}
