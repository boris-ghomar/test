class DomainsImporter{constructor(e,t,a,s,i){this.apiBaseUrl=e,this.payload=t,this.classHandlerVar=s,this.modalLoading=new Modal_loading,this.modalRealize=new ModalRealize("ImportDomainsModalRealize"),this.modalConfirm=new ModalConfirm("ImportDomainsModalConfirm"),this.importView=this.getView(i),this.dataDispalyTableView=this.getView(a);var r=document.createElement("tbody");r.id="DataTableRows",this.dataDispalyTableView.appendChild(r),this.mainCanvas=r,this.progressbarData=null,this.setProgressbar(-1),this.importBtn=this.getView("importBtn"),this.tableDataRowTemplate=this.getView("TableDataRowTemplate"),this.clearCanvas(this.mainCanvas),this.setupImportView()}getView(e,t=!1){try{var a=document.getElementById(e);return is_ElementExist(a)?a:null}catch(a){t&&(alert("No view found with this ID: "+e),this.log(a))}return null}clearCanvas(e){e.innerHTML=""}isEmpty(e){return void 0===e||(null===e||""===e)}displayView(e,t=!0){var a=this.getView(e);if(is_ElementExist(a)){var s="d-none",i=func_hasClass(a,s);t&&i?toggleElementClass(e,s):t||i||toggleElementClass(e,s)}}replaceNull(e){return null==e?"":e}booleanValue(e){return"true"==(e=String(e).toLowerCase())||"1"==e}removeView(e){for(var t=document.getElementById(e);null!=t;)t.parentNode.removeChild(t),t=document.getElementById(e)}setProgressbar(e){var t=this.getView("progressbarContainer"),a=this.getView("progressbar");e<0?(this.displayView(t.id,!1),e=0,this.progressbarData=null,this.setupProgressbarData()):this.displayView(t.id,!0),e>100&&(e=100),e=e.toFixed(1),a.style.width=e+"%",a.setAttribute("aria-valuenow",e),a.innerHTML=e+"%"}setupProgressbarData(e=null,t=null,a=null){var s=this.progressbarData;null==s?s={currentPos:-1,stepSize:null==a?0:a,min:null==e?-1:e,max:null==t?100:t}:(null!=a&&(s.stepSize=a),null!=e&&(s.min=e),null!=t&&(s.max=t)),this.progressbarData=s}progressbarMoveForward(){var e=this.progressbarData;e.currentPos<e.min&&(e.currentPos=e.min),e.currentPos+=e.stepSize,e.currentPos>e.max&&(e.currentPos=e.max),this.setProgressbar(e.currentPos)}getTemporaryID(e=null){var t=Math.floor(100*Math.random())+1,a=Date.now()+""+t;return null!=e&&(a=(e=e.trim())+a),is_ElementExist(this.getView(a))?this.getTemporaryID(e):a}setupImportView(){var e=this.importView;e.addEventListener("input",(t=>{this.clearCanvas(this.mainCanvas);var a=e.value.trim().split("\n"),s=0;a.forEach((e=>{if(!this.isEmpty(e)){var t=e.split("\t"),a={index:s+1},i=JSON.parse(document.getElementById("TableFieldNames").value),r=0;i.forEach((e=>{var s=t[r];this.isEmpty(s)&&(s=""),a[e]=s,r++})),this.addTemplateToView(this.mainCanvas,this.tableDataRowTemplate,"DataRow_"+s,a),s++}}))}))}addTemplateToView(e,t,a,s){var i=this.modifyTempalte(t,a,s);if(null==a)e.innerHTML+=i;else{var r=t.tagName.toLowerCase(),n=document.createElement(r);n.id=a,n.innerHTML=i,e.appendChild(n)}}modifyTempalte(e,t,a){null==t&&(t=this.getTemporaryID());var s=e.innerHTML;if(e.id==this.tableDataRowTemplate.id)for(const[e,t]of Object.entries(a))s=s.replaceAll(e+"_value",t);return s}getServerConnection(e,t=null,a=!0){a&&this.modalLoading.show();var s=new ServerConnection(this.apiBaseUrl);return s.setSubUrl("domains/import_domains/"+e),s.setMethod("POST"),s.appendHeader("locale",locale),s.appendData("payload",this.payload),s.setOnFailed(function(e,a,s){var i=JSON.parse(e.responseText);if(this.modalRealize.setHeader(trans("result.failed")),"string"==typeof i.message)this.modalRealize.setBody(i.message);else{var r="";try{i.message.forEach((e=>{r+="* "+e+"\n"}))}catch(e){r=JSON.stringify(i.message,null,2)}this.modalRealize.setBody(r)}this.modalLoading.close(),this.modalRealize.create(),null!=t&&t(i)}.bind(this)),s}applyDefaultData(e){if(null!=e){var t=e.csrfToken;if(!this.isEmpty(t)){var a=document.getElementsByName("csrf-token");a.length>0&&((a=a[0]).content=t)}this.isEmpty(e.debugMode)||(this.debugMode=this.booleanValue(e.debugMode))}}importData(e=!1){if(this.isEmpty(this.importView.value.trim()))return this.modalRealize.setHeader(trans("result.failed")),this.modalRealize.setBody(document.getElementById("NoDataMsg").value),void this.modalRealize.create();if(e){const e=20;if(this.displayView(this.importBtn.id,!1),this.lastSentRecordIndex<0){let e=100/this.mainCanvas.getElementsByTagName("tr").length;this.setupProgressbarData(0,100,e)}var t=!1,a={};let r=this.lastSentRecordIndex+1,n=this.lastSentRecordIndex+1+e;for(let e=r;e<n;e++){const i="DataRow_"+e,r=document.getElementById(i);if(is_ElementExist(r)){var s=r.getElementsByTagName("td");let t={rowIndex:e};for(let e=0;e<s.length;e++){const a=s[e],i=a.getAttribute("name");this.isEmpty(i)||(t[i]=a.innerHTML)}a[e]=t,this.lastSentRecordIndex=e}else t=!0}if(Object.keys(a).length<1)return this.setProgressbar(-1),this.displayView(this.importBtn.id,!0),void this.modalLoading.close();let l=()=>{this.setProgressbar(-1),this.displayView(this.importBtn.id,!0),this.modalLoading.close()};var i=this.getServerConnection("import",l);i.appendData("domain_category_id",this.getView("domain_category_id").value),i.appendData("domain_holder_account_id",this.getView("domain_holder_account_id").value),i.appendData("Overwrite",this.getView("Overwrite").value),i.appendData("domains",JSON.stringify(a)),i.setOnSuccess(function(e){var a=JSON.parse(e).data;a.importResults.forEach((e=>{let t=e.rowIndex,a=e.result,s=a.status,i=a.message,r="text-success";"Failed"==s?(r="text-danger",i="",a.message.forEach((e=>{i+="* "+e+"<br>"}))):"Ignored"==s&&(r="text-warning");let n="status: "+s;n+="<br>"+i;let l=this.getView("DataRowReslut_"+(t+1));l.className=r,l.innerHTML=n,this.progressbarMoveForward()})),this.applyDefaultData(a),t?(this.setProgressbar(-1),this.displayView(this.importBtn.id,!0),this.modalLoading.close()):setTimeout((()=>{this.importData(!0)}),1100)}.bind(this)),i.connect()}else{this.lastSentRecordIndex=-1;var r=this.modalConfirm,n=document.getElementById("ConfirmImportMsg").value;r.setHeader(document.getElementById("ConfirmImportTitle").value),r.setBody(n),r.create(),r.setOnYesPressed((()=>{this.importData(!0)}))}}}
