class ChatbotMessenger{constructor(e,t,s,a){this.apiBaseUrl=e,this.payload=t,this.classHandlerVar=a,this.LastServerMessage=null,this.displayView("site_footer",!1),this.displayView("SupportChatbotIcon",!1),this.modalZoomImage=new ModalZoomImage,this.MESSAGE_TYPE_TEXT="Text",this.MESSAGE_TYPE_IMAGE="Image",this.MESSAGE_TYPE_BUTTON="Button",this.MESSAGE_TYPE_INPUT="Input",this.MESSAGE_TYPE_FILTER="Filter",this.MESSAGE_TYPE_BOT_ACTION="BotAction",this.mainCanvas=this.getView(s),this.loadingTemplate=this.getView("LoadingTemplate"),this.messageTemplate=this.getView("MessageTemplate"),this.chatbotProfileTemplate=this.getView("ChatbotProfileTemplate"),this.userProfileTemplate=this.getView("UserProfileTemplate"),this.errorMsgImageRemoved=document.getElementById("ChatbotMessenger_ImageRemoved").value,this.clearCanvas(this.mainCanvas),this.getInitialData()}getView(e,t=!1){try{var s=document.getElementById(e);return is_ElementExist(s)?s:null}catch(s){t&&(alert("No view found with this ID: "+e),console.log(s))}return null}clearCanvas(e){e.innerHTML=""}isEmpty(e){return null==e||(null==e||""==e)}imageNotLoaded(e){var t='<i class="fa-regular fa-image"></i><br>';t+='<small class="text-muted">'+document.getElementById("ChatbotMessenger_ImageRemoved").value+"</small>",e.parentNode.innerHTML=t}scrolldown(){var e=this.mainCanvas;setTimeout((function(){e.scrollIntoView(!1)}),500)}getTemporaryID(e=null){var t=Math.floor(100*Math.random())+1,s=Date.now()+""+t;return null!=e&&(s=(e=e.trim())+s),is_ElementExist(this.getView(s))?this.getTemporaryID(e):s}replaceNull(e){return null==e?"":e}booleanValue(e){return"true"==(e=String(e).toLowerCase())||"1"==e}getServerConnection(e,t=null){this.displayBotWaiting(!0);var s=new ServerConnection(this.apiBaseUrl);return s.setSubUrl("chatbot/messenger/"+e),s.setMethod("POST"),s.appendHeader("locale",locale),s.appendData("payload",this.payload),s.setOnFailed(function(e,s,a){var i=JSON.parse(e.responseText),l="";if("string"==typeof i.message)l=i.message;else try{i.message.forEach((e=>{l+="* "+e+"\n"}))}catch(e){l=JSON.stringify(i.message,null,2)}"exception.CSRF token mismatch."==l&&window.location.reload(),console.log(l),this.isEmpty(i.data)||this.booleanValue(i.data.refreshPage)&&window.location.reload(),this.displayBotWaiting(!1);var n=!1;["exception","server error"].forEach((e=>{l.toLowerCase().includes(e.toLowerCase())&&(n=!0)})),n||this.addTextMessageView(!0,l),null!=t&&t(i)}.bind(this)),s}applyDefaultData(e){if(null!=e){var t=e.csrfToken;if(null!=t){var s=document.getElementsByName("csrf-token");s.length>0&&((s=s[0]).content=t)}}}displayView(e,t=!0){var s=this.getView(e);if(is_ElementExist(s)){var a="d-none",i=func_hasClass(s,a);t&&i?toggleElementClass(e,a):t||i||toggleElementClass(e,a)}}addProfileView(e){var t="",s=null,a=!1;this.isBotSentLastMessage!=e&&(a=!0,this.isBotSentLastMessage=e),a&&(e?(t=this.chatbotProfileTemplate,s=this.chatbotProfile):(t=this.userProfileTemplate,s=this.clientProfile),this.addTemplateToView(this.mainCanvas,t,null,s))}addTextMessageView(e,t,s=null){var a={id:null==s?this.getTemporaryID("text_msg_"):s,is_bot_message:e,type:this.MESSAGE_TYPE_TEXT,content:{Message:t},is_passed:!0};this.addMessageView(a)}addMessageView(e){if(null!=e){var t,s,a,i,l=null;try{if(e.id,t=e.is_bot_message,s=e.type,a=e.content,i=e.is_passed,s==this.MESSAGE_TYPE_FILTER)return;if(s==this.MESSAGE_TYPE_BOT_ACTION)return;switch(this.addProfileView(t),s){case this.MESSAGE_TYPE_TEXT:l=this.getMsgTextView(a);break;case this.MESSAGE_TYPE_IMAGE:l=this.getMsgImageView(a);break;case this.MESSAGE_TYPE_BUTTON:l=this.getMsgButtonView(a);break;case this.MESSAGE_TYPE_INPUT:l=this.getMsgInputView(a,i);case this.MESSAGE_TYPE_FILTER:}}catch(e){l=null,console.log(e)}if(null!=l){var n={isBotMessage:t,messageType:s,messageView:l};this.addTemplateToView(this.mainCanvas,this.messageTemplate,null,n)}}}getMsgTextView(e){var t=null,s=e.Message.replaceAll("\n","<br>");return null!=s&&""!=s&&(t='<small class="text-muted">'+s+"</small>"),t}getMsgImageView(e){var t=null,s=e.FileName;null!=s&&""!=s&&(t='<img class="chat-image" src="'+(this.imageResponsePath+s)+'"',t+=' onerror="'+this.classHandlerVar+'.imageNotLoaded(this);"',t+=' onclick="'+this.classHandlerVar+'.zoomImage(this);" ',t+=" >");return t}getMsgButtonView(e){var t=null,s=e.Type,a=e.Title;if("GoToStep"==s){var i=e.TargetStep;t='<button type="button" class="btn btn-primary" onclick="'+(this.classHandlerVar+".getNextStepMessage('"+i+"');")+'" >'+a+"</button>"}else if("OpenUrl"==s){t='<button type="button" class="btn btn-success" onclick="'+("window.open('"+e.TargetUrl+"', '_blank');")+'" >'+a+"</button>"}return t}getMsgInputView(e,t){var s=null;switch(e.Type){case"Number":s=t?this.getView("InputNumberPassedTemplate"):this.getView("InputNumberTemplate");break;case"OneLineText":s=t?this.getView("InputOneLineTextPassedTemplate"):this.getView("InputOneLineTextTemplate");break;case"MultipleLineText":s=t?this.getView("InputMultipleLineTextPassedTemplate"):this.getView("InputMultipleLineTextTemplate");break;case"Image":s=t?this.getView("InputImagePassedTemplate"):this.getView("InputImageTemplate");break;default:return null}return this.modifyTempalte(s,null,e)}addTemplateToView(e,t,s,a){var i=this.modifyTempalte(t,s,a);if(null==s)e.innerHTML+=i;else{var l="<div id='"+s+"'>";l+=i,l+="</div>",e.innerHTML+=l}this.scrolldown()}modifyTempalte(e,t,s){null==t&&(t=this.getTemporaryID());var a=e.innerHTML;if("MessageTemplate"==e.id){var i=s.isBotMessage,l=s.messageType,n=s.messageView;a=(a=(a=(a=a.replaceAll("MessageTemplate_isBotMessage",i)).replaceAll("MessageTemplate_MessageType",l)).replaceAll("MessageTemplate_Style1",i?"me-5 flex-row-reverse":"ms-5")).replaceAll("MessageTemplate_MessageView",n)}else if("InputNumberTemplate"==e.id||"InputNumberPassedTemplate"==e.id||"InputOneLineTextTemplate"==e.id||"InputOneLineTextPassedTemplate"==e.id||"InputMultipleLineTextTemplate"==e.id||"InputMultipleLineTextPassedTemplate"==e.id||"InputImageTemplate"==e.id||"InputImagePassedTemplate"==e.id){var r=this.getTemporaryID(),o=s.Data,p=this.replaceNull(o.Title),g=this.replaceNull(o.Description);if(null!=g&&""!=g&&(p+="<br>( "+g+" )"),a=(a=(a=(a=(a=a.replaceAll("TemplateViewID",r)).replaceAll("InputTemplate_Label",p)).replaceAll("InputTemplate_Placeholder",this.replaceNull(o.Placeholder))).replaceAll("InputPassedTemplate_UserAnswer",this.replaceNull(s.UserAnswer))).replaceAll("TemplateClassHandlerVar",this.classHandlerVar),"InputImagePassedTemplate"==e.id){var h=this.isEmpty(s.UserAnswer)?"":'<img class="chat-image" src="'+this.userInputImagePath+s.UserAnswer+'" onclick="'+this.classHandlerVar+'.zoomImage(this);" >';a=a.replaceAll("InputImageTemplate_View",h)}var m=this.classHandlerVar+".submitUserInput('"+o.StepId+"','"+r+"')";a=a.replaceAll("InputTemplate_SubmitFunc",m)}else if("ChatbotProfileTemplate"==e.id||"UserProfileTemplate"==e.id){a=(a=a.replaceAll("ProfileTemplate_DisplayName",s.dispalyName)).replaceAll("profile_image_src",'src="'+s.profileImage+'"')}return a}displayBotWaiting(e=!0){var t="botWaiting";this.removeView(t),e&&this.addTemplateToView(this.mainCanvas,this.loadingTemplate,t)}removeView(e){for(var t=document.getElementById(e);null!=t;)t.parentNode.removeChild(t),t=document.getElementById(e)}userinputImageFileChanged(e,t){var s=e.value,a="";try{a=s.split("\\").pop()}catch(e){a=s}this.getView("MsgInputFileName_"+t).setAttribute("value",a),this.displayView("MsgSubmitBtn_"+t,!0)}getInitialData(){var e=this.getServerConnection("get_initial_data");e.setOnSuccess(function(e){var t=JSON.parse(e).data;this.displayBotWaiting(!1),this.imageResponsePath=t.imagesBasePath.imageResponse,this.userInputImagePath=t.imagesBasePath.userInputImage,this.chatbotProfile=t.chatbotProfile,this.clientProfile=t.clientProfile,this.getPreviousMessages()}.bind(this)),e.connect()}getPreviousMessages(){var e=this.getServerConnection("get_previous_messages");e.setOnSuccess(function(e){var t=JSON.parse(e).data;this.displayBotWaiting(!1);var s=t.messages;null!=s&&s.forEach((e=>{this.addMessageView(e),this.LastServerMessage=e})),this.applyDefaultData(t),this.getNextStepMessage()}.bind(this)),e.connect()}getNextStepMessage(e=null){var t,s=e=>{try{var t=e.data.GoToStep;this.isEmpty(t)||this.getNextStepMessage(t)}catch(e){console.warn(e)}};null==e?t=this.getServerConnection("get_next_step_message",s):(t=this.getServerConnection("go_to_step",s)).appendData("stepId",e),t.setOnSuccess(function(e){var t=JSON.parse(e).data;if(null!=t){this.LastServerMessage=t;var s=t.delay;null==s&&(s=0),setTimeout(function(){this.displayBotWaiting(!1),this.addMessageView(t),this.applyDefaultData(t),this.getNextStepMessage()}.bind(this),1e3*s)}else this.displayBotWaiting(!1)}.bind(this)),t.connect()}submitUserInput(e,t){var s=!0;null==e&&(s=!1);var a=this.getView("MsgInput_"+t),i=this.getView("MsgSubmitBtn_"+t),l=this.getView("MsgStatusView_"+t);is_ElementExist(a)||(s=!1);var n=a.value,r=a.tagName.toLowerCase();if("input"==r&&"file"==a.type){n=a.files[0];var o=this.getView("MsgFileUploadInfo_"+t);if(o.parentNode.removeChild(o),null==n)n=null;else{var p=new FileReader;p.addEventListener("load",function(){var e=p.result;document.getElementById("MsgImagePreview_"+t).innerHTML='<img class="chat-image" src="'+e+'" onclick="'+this.classHandlerVar+'.zoomImage(this);" >',this.scrolldown()}.bind(this)),p.readAsDataURL(n)}}else"textarea"==r?a.innerHTML=n:a.setAttribute("value",n);if(s){i.parentNode.removeChild(i),a.disabled=!0,l.innerHTML='<i class="fa-duotone fa-spinner fa-spin-pulse"></i>';var g=function(){this.getView(l.id).innerHTML='<i class="fa-solid fa-xmark text-danger"></i>',this.addMessageView(this.LastServerMessage)}.bind(this),h=this.getServerConnection("submit_user_input",g);h.appendData("stepId",e),h.appendData("userInput",n),h.setOnSuccess(function(e){var t=JSON.parse(e).data;null!=t?(this.displayBotWaiting(!1),this.applyDefaultData(t),this.getView(l.id).innerHTML='<i class="fa-duotone fa-check text-success"></i>',this.getNextStepMessage()):this.displayBotWaiting(!1)}.bind(this)),h.connect()}else this.displayBotWaiting(!1)}closeChat(){var e;(e=this.getServerConnection("close_chat")).setOnSuccess(function(e){var t=JSON.parse(e).data;if(null!=t){var s=t.redirectUrl;this.displayBotWaiting(!1),this.isEmpty(s)||window.open(s,"_parent")}else this.displayBotWaiting(!1)}.bind(this)),e.connect()}zoomImage(e){this.modalZoomImage.setImage(e.src),this.modalZoomImage.show()}}
