class ClientProfileController{constructor(e){this.apiBaseUrl=e,this.debugMode=!1,this.modalLoading=new Modal_loading,this.modalRealize=new ModalRealize("ProfileModalRealize"),this.provincesCitiesCollection=[],this.provinceSelectView=func_getView("province_internal"),this.citySelectView=func_getView("city_internal"),this.selectedCity=func_getView(this.citySelectView.id+"_selectedItem").value,this.provinceSelectView.addEventListener("change",(e=>{this.provinceChanged()})),this.showIncompleteTab(),this.provinceChanged()}showIncompleteTab(){var e=document.querySelector('[id$="_tab_errors"]');if(!func_isEmpty(e))return;let t=window.location.href.split("#");["further_information","change_email"].every((e=>{let i=e+"-tab";if(is_ElementExistById(e+"-incomplete")){let a="#"+e;if(sessionStorage.setItem("activeTab",a),func_getView(i).click(),window.location.href=t[0]+a,"further_information"==e&&!is_ElementExistById(e+"_tab_errors")){func_getView(e+"_form").submit()}return!1}return!0}))}getServerConnection(e,t=null,i=!0){i&&this.modalLoading.show();var a=new ServerConnection(this.apiBaseUrl);return a.setSubUrl("profile/"+e),a.setMethod("POST"),a.appendHeader("locale",locale),a.appendData("_apiAction",e),a.setOnFailed(function(e,i,a){var n=JSON.parse(e.responseText);if(this.modalRealize.setHeader(trans("result.failed")),"string"==typeof n.message)this.modalRealize.setBody(n.message);else{var o="";try{n.message.forEach((e=>{o+="* "+e+"\n"}))}catch(e){o=JSON.stringify(n.message,null,2)}this.modalRealize.setBody(o)}"exception.CSRF token mismatch."==o&&window.location.reload(),null!=n.data&&!0===n.data.refreshPage&&window.location.reload(),this.modalLoading.close(),this.modalRealize.create(),null!=t&&t(n)}.bind(this)),a}applyDefaultData(e){if(null!=e){var t=e.csrfToken;if(!func_isEmpty(t)){var i=document.getElementsByName("csrf-token");i.length>0&&((i=i[0]).content=t)}func_isEmpty(e.debugMode)||(this.debugMode=func_booleanValue(e.debugMode))}}provinceChanged(){let e=this.provincesCitiesCollection,t=this.provinceSelectView.value,i=e[t];if(func_isEmpty(i)){var a=this.getServerConnection("get_cities");a.appendData("province",t),a.setOnSuccess(function(e){var i=JSON.parse(e).data;let a=i.cities;this.provincesCitiesCollection[t]=a,this.modifyCitiesDropdown(a),this.applyDefaultData(i),this.modalLoading.close()}.bind(this)),a.connect()}else this.modifyCitiesDropdown(i)}modifyCitiesDropdown(e){let t=this.citySelectView;t.innerHTML="";var i=!1;func_forEach(e,((e,a)=>{let n=document.createElement("option");n.value=a,n.innerHTML=e,a==this.selectedCity&&(n.selected="selected"),t.appendChild(n),i=!0})),func_displayView(t.id+"-widget",i)}sendEmailVerification(){let e=func_getView("email").value;var t=this.getServerConnection("send_email_verification");t.appendData("email",e),t.setOnSuccess(function(e){var t=JSON.parse(e),i=t.data;this.applyDefaultData(i),this.modalLoading.close(),this.modalRealize.setHeader(trans("result.success")),this.modalRealize.setBody(t.message),this.modalRealize.setOnClose((()=>{window.location.reload()})),this.modalRealize.create()}.bind(this)),t.connect()}}
