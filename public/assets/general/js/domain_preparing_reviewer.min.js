class DomainPreparingReviewer{constructor(e,i){this.apiBaseUrl=e,this.classHandlerVar=i,this.lastPassedIds=[],this.currentDomainId=-1,this.modalLoading=new Modal_loading,this.modalRealize=new ModalRealize("DomainPreparingReviewerModalRealize"),this.modalConfirm=new ModalConfirm("DomainPreparingReviewerModalConfirm"),this.domainNameDisplayView=func_getView("domainNameDisplay"),this.descrView=func_getView("descr"),this.submitSection=func_getView("submitSection"),this.mobileCheckButtonsSection=func_getView("mobileCheckButtonsSection"),this.desktopCheckButtonsSection=func_getView("desktopCheckButtonsSection"),this.btnMobileSuccess=func_getView("btnMobileSucccess"),this.btnMobileFailed=func_getView("btnMobileFailed"),this.btnDesktopSuccess=func_getView("btnDesktopSucccess"),this.btnDesktopFailed=func_getView("btnDesktopFailed"),this.iframDomainCheckMobile=func_getView("iframDomainCheckMobile"),this.iframDomainCheckDesktop=func_getView("iframDomainCheckDesktop"),this.descrView.addEventListener("input",(e=>{this.descrView.innerHTML=this.descrView.value})),this.resetCheckParams(),this.getDomainForReview()}resetCheckParams(){this.descrView.value="",this.iframesLoadStatus=0,this.mobileLoadRealut=null,this.desktopLoadRealut=null,func_displayView(this.submitSection.id,!1),func_displayView(this.mobileCheckButtonsSection.id,!1),func_displayView(this.desktopCheckButtonsSection.id,!1),this.btnMobileSuccess.removeAttribute("disabled"),this.btnMobileFailed.removeAttribute("disabled"),this.btnDesktopSuccess.removeAttribute("disabled"),this.btnDesktopFailed.removeAttribute("disabled")}iframeLoaded(e){"mobile"==e&&(this.iframesLoadStatus+=1),"desktop"==e&&(this.iframesLoadStatus+=2),3==this.iframesLoadStatus&&(func_displayView(this.submitSection.id,!0),func_displayView(this.mobileCheckButtonsSection.id,!0),func_displayView(this.desktopCheckButtonsSection.id,!0))}loadResult(e,i){let t,s,a=null;"mobile"==e?(this.mobileLoadRealut=i,t=this.btnMobileSuccess,s=this.btnMobileFailed,a="Mobile load failed"):"desktop"==e&&(this.desktopLoadRealut=i,t=this.btnDesktopSuccess,s=this.btnDesktopFailed,a="Desktop load failed");let o=this.descrView.value;i?(t.setAttribute("disabled",!0),s.removeAttribute("disabled"),o=o.replaceAll(a,"")):(t.removeAttribute("disabled"),s.setAttribute("disabled",!0),o.includes(a)||(func_isEmpty(o)||(o+="\n"),o+=a)),this.descrView.value=o.trim()}refreshDisplays(){let e=this.descrView.value;this.resetCheckParams();let i=this.iframDomainCheckDesktop.src,t=this.iframDomainCheckMobile.src;this.iframDomainCheckDesktop.src="about:blank",this.iframDomainCheckMobile.src="about:blank",setTimeout((()=>{this.iframDomainCheckDesktop.src=i,this.iframDomainCheckMobile.src=t}),300),this.descrView.value=e}getLastPassedDomainId(){let e=this.lastPassedIds.length;return e>0?this.lastPassedIds[e-1]:-1}moveBackwardStep(e=1){let i=this.lastPassedIds.length;if(i<e)return this.lastPassedIds=[],void window.location.reload();let t=this.getLastPassedDomainId(i-e);this.lastPassedIds.splice(i-e,e),this.getDomainForReview(t)}getServerConnection(e,i=null,t=!0){t&&this.modalLoading.show();var s=new ServerConnection(this.apiBaseUrl);return s.setSubUrl("domains/preparing_review/"+e),s.setMethod("POST"),s.appendHeader("locale",locale),s.setOnFailed(function(e,t,s){var a=JSON.parse(e.responseText);if(this.modalRealize.setHeader(trans("result.failed")),"string"==typeof a.message)this.modalRealize.setBody(a.message);else{var o="";try{a.message.forEach((e=>{o+="* "+e+"\n"}))}catch(e){o=JSON.stringify(a.message,null,2)}this.modalRealize.setBody(o)}this.modalLoading.close(),this.modalRealize.create(),null!=i&&i(a)}.bind(this)),s}applyDefaultData(e){if(null!=e){var i=e.csrfToken;if(!func_isEmpty(i)){var t=document.getElementsByName("csrf-token");t.length>0&&((t=t[0]).content=i)}func_isEmpty(e.debugMode)||(this.debugMode=func_booleanValue(e.debugMode))}}getDomainForReview(e=null){this.resetCheckParams();var i=this.getServerConnection("get_domain_for_review");i.appendData("lastPassedId",this.getLastPassedDomainId()),func_isEmpty(e)||i.appendData("forceId",e),i.setOnSuccess(function(e){var i=JSON.parse(e).data,t=i.domain;if(func_isEmpty(t))func_displayView("DomainCheckSection",!1),func_displayView("NoDomainMsg",!0);else{func_displayView("DomainCheckSection",!0),func_getView("remainingDomainsCount").innerHTML=i.remainingDomainsCount;let e=t.id,s=t.name,a=t.descr;this.currentDomainId=e,this.descrView.value=func_replaceNull(a),this.domainNameDisplayView.innerHTML=s;let o=func_getView("iframDomainCheckMobile"),n=func_getView("iframDomainCheckDesktop");o.src="https://m."+s,n.src="https://"+s}this.applyDefaultData(i),this.modalLoading.close()}.bind(this)),i.connect()}submit(){if(this.modalRealize.setHeader(trans("result.failed")),func_isEmpty(this.mobileLoadRealut))return this.modalRealize.setBody(func_getView("UnknownMobileLoadResultMsg").value),void this.modalRealize.create();if(func_isEmpty(this.desktopLoadRealut))return this.modalRealize.setBody(func_getView("UnknownDesktopLoadResultMsg").value),void this.modalRealize.create();var e=this.getServerConnection("submit_review");e.appendData("domain",this.domainNameDisplayView.innerHTML),e.appendData("mobileLoadRealut",this.mobileLoadRealut),e.appendData("desktopLoadRealut",this.desktopLoadRealut),e.appendData("descr",this.descrView.value),e.setOnSuccess(function(e){var i=JSON.parse(e).data;this.lastPassedIds.push(this.currentDomainId),this.applyDefaultData(i),this.modalLoading.close(),this.getDomainForReview()}.bind(this)),e.connect()}}
