class BcLogin{constructor(e,t=!1){this.apiBaseUrl=e,this.debugMode=t,this.modalLoading=new Modal_loading,this.bcSwarmApi=null,this.loginFormView=this.getView("login_form"),this.errorContainerView=this.getView("jsErrorContainer"),this.errorMessageView=this.getView("jsErrorMessage"),this.progressbarData=null,this.setProgressbar(-1),this.btnSubmit=this.getView("btn_submit"),this.displayView(this.btnSubmit.id,!1),this.btnSubmit.addEventListener("click",function(e){e.preventDefault(),this.btnSumbitClicked()}.bind(this)),this.getInitialData()}getInitialData(){var e=this.getServerConnection("get_initial_data",!1,(function(){setTimeout((function(){window.location.reload()}),500)}));e.setOnSuccess(function(e){var t=JSON.parse(e).data;this.targetRedirectUrl=t.targetRedirectUrl,this.appendBcSwarm(t.swarmSrc)}.bind(this)),e.connect()}isEmpty(e){return null==e||(null==e||""==e)}setProgressbar(e){var t=this.getView("progressbarContainer"),i=this.getView("progressbar");e<0?(this.displayView(t.id,!1),e=0,this.progressbarData=null,this.setupProgressbarData()):this.displayView(t.id,!0),e>100&&(e=100),i.style.width=e+"%",i.setAttribute("aria-valuenow",e),i.innerHTML=e+"%"}setupProgressbarData(e=null,t=null,i=null){var s=this.progressbarData;null==s?s={currentPos:-1,stepSize:null==i?0:i,min:null==e?-1:e,max:null==t?100:t}:(null!=i&&(s.stepSize=i),null!=e&&(s.min=e),null!=t&&(s.max=t)),this.progressbarData=s}progressbarMoveForward(){var e=this.progressbarData;e.currentPos<e.min&&(e.currentPos=e.min),e.currentPos+=e.stepSize,e.currentPos>e.max&&(e.currentPos=e.max),this.setProgressbar(e.currentPos)}log(e,t="log"){if(this.debugMode&&!this.isEmpty(e))switch(t){case"log":default:console.log(e);break;case"error":console.error(e);break;case"warn":console.warn(e)}}getView(e,t=!1){try{var i=document.getElementById(e);return is_ElementExist(i)?i:null}catch(i){t&&(alert("No view found with this ID: "+e),this.log(i))}return null}displayView(e,t=!0){var i=this.getView(e);if(is_ElementExist(i)){var s="d-none",r=func_hasClass(i,s);t&&r?toggleElementClass(e,s):t||r||toggleElementClass(e,s)}}displayError(e){this.isEmpty(e)||(this.errorMessageView.innerHTML=e,this.displayView(this.errorContainerView.id,!0))}appendGoogleRecaptcha(){if(null==this.googleRecaptchSiteKeyView&&(this.googleRecaptchSiteKeyView=this.getView("googleRecaptchSiteKey"),this.gRecaptchaResponseView=this.getView("g_recaptcha_response"),this.googleRecaptchSiteKeyView.addEventListener("change",function(e){this.appendGoogleRecaptcha()}.bind(this))),this.googleRecaptchSiteKey=this.googleRecaptchSiteKeyView.value,!this.isEmpty(this.googleRecaptchSiteKey)){var e="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render="+this.googleRecaptchSiteKey,t="google_recaptcha",i=this.getView(t);if(null==i){var s=document.createElement("script");s.id=t,s.src=e,s.setAttribute("async",""),s.setAttribute("defer",""),document.body.appendChild(s)}else i.src=e}}appendBcSwarm(e){var t=document.createElement("script");t.src=e,t.addEventListener("load",function(e){this.appendGoogleRecaptcha(),this.bcSwarmApi=new BcSwarmApi(this.apiBaseUrl,this.googleRecaptchSiteKeyView,this.debugMode),this.bcSwarmApi.setProgressbarMoveForwardFunction(this.progressbarMoveForward.bind(this)),setTimeout((()=>{this.displayView(this.btnSubmit.id,!0)}),3e3)}.bind(this)),document.body.appendChild(t)}getServerConnection(e,t=!1,i=null){t&&this.modalLoading.show();var s=new ServerConnection(this.apiBaseUrl);return s.setSubUrl("bclogin/"+e),s.setMethod("POST"),s.appendHeader("locale",locale),s.setOnFailed(function(e,s,r){var a=JSON.parse(e.responseText),o="";if("string"==typeof a.message)o=a.message;else try{a.message.forEach((e=>{o+="* "+e+"\n<br>"}))}catch(e){o=JSON.stringify(a.message,null,2)}"exception.CSRF token mismatch."==o&&window.location.reload(),null!=a.data&&!0===a.data.refreshPage&&window.location.reload(),this.log(o),null!=i&&i(o),t&&this.modalLoading.close()}.bind(this)),s}btnSumbitClicked(){var e=this.getView("username").value.trim(),t=this.getView("password").value.trim();if(this.isEmpty(e))this.displayError(usernameReqired);else if(this.isEmpty(t))this.displayError(passwordReqired);else if(this.modalLoading.show(),this.setupProgressbarData(0,10,10),this.isEmpty(this.googleRecaptchSiteKey))this.collectClientData(e,t,null);else try{grecaptcha.ready(function(){grecaptcha.execute(this.googleRecaptchSiteKey,{action:"submit"}).then(function(i){this.gRecaptchaResponseView.value=i,this.collectClientData(e,t,i)}.bind(this))}.bind(this))}catch(i){this.collectClientData(e,t,null)}}collectClientData(e,t,i=null){this.setupProgressbarData(20,45,5),this.progressbarMoveForward();var s=e=>{this.displayError(e),this.modalLoading.close(),this.setProgressbar(-1)};this.bcSwarmApi.requestLogin(e,t,i).then((i=>{this.setupProgressbarData(45,75,5),this.progressbarMoveForward();var r=JSON.stringify(i);this.bcSwarmApi.requestGetUser().then((i=>{this.setupProgressbarData(75,95,5),this.progressbarMoveForward();var a=JSON.stringify(i),o=this.getServerConnection("attempt",!1,s);o.appendData("username",e),o.appendData("password",t),o.appendData("remember",this.getView("remember").value),o.appendData("loginData",r),o.appendData("getUserData",a),o.setOnSuccess((e=>{JSON.parse(e);this.setProgressbar(100),func_isEmpty(this.targetRedirectUrl)?"referrer"in document?window.location=document.referrer:window.location.reload():window.location=this.targetRedirectUrl})),o.connect()}),s)}),s)}}
